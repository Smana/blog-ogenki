<!doctype html><html lang=en data-figures class=page><head><title>`CloudNativePG`: An easy way to run PostgreSQL on Kubernetes | Ogenki</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta http-equiv=x-ua-compatible content="IE=edge"><script async src="https://www.googletagmanager.com/gtag/js?id=XXXXXXXXXX"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","XXXXXXXXXX")</script><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta name=description content="CloudNativePG is a Kubernetes operator that helps running and operating PostgreSQL databases. Here I'll demonstrate how to create a server, perform backups and …"><meta name=twitter:card content="summary"><meta name=twitter:creator content="@_smana_"><meta name=twitter:title content="`CloudNativePG`: An easy way to run PostgreSQL on Kubernetes"><meta name=twitter:image content="https://blog.ogenki.io/post/cnpg/cloudnativepg.png"><meta property="og:url" content="https://blog.ogenki.io/post/cnpg/"><meta property="og:title" content="`CloudNativePG`: An easy way to run PostgreSQL on Kubernetes"><meta property="og:description" content="CloudNativePG is a Kubernetes operator that helps running and operating PostgreSQL databases. Here I'll demonstrate how to create a server, perform backups and …"><meta property="og:image" content="https://blog.ogenki.io/post/cnpg/cloudnativepg.png"><link rel=apple-touch-icon sizes=180x180 href=https://blog.ogenki.io/icons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://blog.ogenki.io/icons/favicon-32x32.png><link rel=manifest href=https://blog.ogenki.io/icons/site.webmanifest><link rel=canonical href=https://blog.ogenki.io/post/cnpg/><link rel=preload href=https://blog.ogenki.io/css/styles.367129801480fead578d7a356a98fcb3bce794981ff18cee55868d198d0d2bf1eb4feac97319d0871c6255183b9fd27a7059e4632c785951f4c4f6953559c4d0.css integrity="sha512-NnEpgBSA/q1XjXo1apj8s7znlJgf8YzuVYaNGY0NK/HrT+rJcxnQhxxiVRg7n9J6cFnkYyx4WVH0xPaVNVnE0A==" as=style crossorigin=anonymous><link rel=preload href=https://blog.ogenki.io/en/js/bundle.4e04b93422786398f3502d560bd5acb3d3f99b2e942c8c11e0fd926ab6ec3ccbd020d4294d58c0825ecb606ef221b34edc81586f1832489816a57ae8f0276615.js as=script integrity="sha512-TgS5NCJ4Y5jzUC1WC9Wss9P5my6ULIwR4P2SarbsPMvQINQpTVjAgl7LYG7yIbNO3IFYbxgySJgWpXro8CdmFQ==" crossorigin=anonymous><link rel=stylesheet type=text/css href=https://blog.ogenki.io/css/styles.367129801480fead578d7a356a98fcb3bce794981ff18cee55868d198d0d2bf1eb4feac97319d0871c6255183b9fd27a7059e4632c785951f4c4f6953559c4d0.css integrity="sha512-NnEpgBSA/q1XjXo1apj8s7znlJgf8YzuVYaNGY0NK/HrT+rJcxnQhxxiVRg7n9J6cFnkYyx4WVH0xPaVNVnE0A==" crossorigin=anonymous></head><body data-code=20 data-lines=false id=documentTop><header class=nav_header><nav class=nav><a href=https://blog.ogenki.io/ class="nav_brand nav_item" title=Ogenki><img src=https://blog.ogenki.io/logos/logo.png class=logo alt=Ogenki><div class=nav_close><div><svg class="icon"><title>open-menu</title><use xlink:href="#open-menu"/></svg><svg class="icon"><title>closeme</title><use xlink:href="#closeme"/></svg></div></div></a><div class='nav_body nav_body_left'><div class=nav_parent><a href=https://blog.ogenki.io/ class=nav_item title=Home>Home</a></div><div class=nav_parent><a href=https://blog.ogenki.io/post/rich-content/ class=nav_item title=Archives>Archives</a></div><div class=nav_parent><a href=https://blog.ogenki.io/ class=nav_item title=Links>Links <img src=https://blog.ogenki.io/icons/caret-icon.svg alt=icon class=nav_icon></a><div class=nav_sub><span class=nav_child></span>
<a href=https://www.linkedin.com/in/sma%C3%AFne-kahlouch-44374110/ class="nav_child nav_item" title=LinkedIn>LinkedIn</a>
<a href=https://twitter.com/_smana_ class="nav_child nav_item" title=Twitter>Twitter</a></div></div><div class=nav_parent><a href=https://blog.ogenki.io/about/ class=nav_item title=About>About</a></div><div class=nav_parent><a href=# class=nav_item>🌐</a><div class=nav_sub><span class=nav_child></span>
<a href=https://blog.ogenki.io/ class="nav_child nav_item">English</a>
<a href=https://blog.ogenki.io/fr/ class="nav_child nav_item">Français</a></div></div><div class=follow><a href=https://github.com/Smana><svg class="icon"><title>github</title><use xlink:href="#github"/></svg></a><a href=https://twitter.com/_smana_><svg class="icon"><title>twitter</title><use xlink:href="#twitter"/></svg></a><a href=https://www.linkedin.com/in/sma%C3%AFne-kahlouch-44374110/><svg class="icon"><title>linkedin</title><use xlink:href="#linkedin"/></svg></a><div class=color_mode><input type=checkbox class=color_choice id=mode></div></div></div></nav></header><main><div class="grid-inverse wrap content"><article class=post_content><h1 class=post_title><code>CloudNativePG</code>: An easy way to run PostgreSQL on Kubernetes</h1><div class=post_meta><span><svg class="icon"><title>calendar</title><use xlink:href="#calendar"/></svg></span><span class=post_date>23-10-2022</span>
<span class=post_time>· 15 min read</span><span>&nbsp;· <a href=https://blog.ogenki.io/tags/data/ title=data class="post_tag button button_translucent">data</a></span>
<span class=page_only>&nbsp;·<div class=post_share>Share on:
<a href="https://twitter.com/intent/tweet?text=%60CloudNativePG%60%3a%20An%20easy%20way%20to%20run%20PostgreSQL%20on%20Kubernetes&url=https%3a%2f%2fblog.ogenki.io%2fpost%2fcnpg%2f&tw_p=tweetbutton" class=twitter title="Share on Twitter" target=_blank rel=nofollow><svg class="icon"><title>twitter</title><use xlink:href="#twitter"/></svg></a><a href="https://www.facebook.com/sharer.php?u=https%3a%2f%2fblog.ogenki.io%2fpost%2fcnpg%2f&t=%60CloudNativePG%60%3a%20An%20easy%20way%20to%20run%20PostgreSQL%20on%20Kubernetes" class=facebook title="Share on Facebook" target=_blank rel=nofollow><svg class="icon"><title>facebook</title><use xlink:href="#facebook"/></svg></a><a href=#linkedinshare id=linkedinshare class=linkedin title="Share on LinkedIn" rel=nofollow><svg class="icon"><title>linkedin</title><use xlink:href="#linkedin"/></svg></a><a href=https://blog.ogenki.io/post/cnpg/ title="Copy Link" class="link link_yank"><svg class="icon"><title>copy</title><use xlink:href="#copy"/></svg></a></div></span></div><div class=post_featured><figure><picture><img loading=lazy decoding=async alt class="image_figure image_featured image_internal image_unprocessed" src=/post/cnpg/cnpg.png></picture></figure></div><div class=post_toc><h2>Overview</h2><nav id=TableOfContents><ul><li><a href=#-our-target>🎯 Our target</a></li><li><a href=#-requirements>☑️ Requirements</a><ul><li><a href=#-install-required-tools>📥 Install required tools</a></li><li><a href=#-create-the-google-cloud-requirements>☁️ Create the Google cloud requirements</a></li><li><a href=#-create-the-users-secrets>🔑 Create the users secrets</a></li></ul></li><li><a href=#-deploy-the-cloudnativepg-operator-using-helm>🛠️ Deploy the CloudNativePG operator using Helm</a></li><li><a href=#-create-a-postgresql-server>🚀 Create a PostgreSQL server</a></li><li><a href=#-standby-instance-and-resiliency>🩹 Standby instance and resiliency</a></li><li><a href=#-monitoring>👁️ Monitoring</a></li><li><a href=#-performances-and-benchmark>🔥 Performances and benchmark</a></li><li><a href=#-backup-and-restore>💽 Backup and Restore</a></li><li><a href=#-cleanup>🧹 Cleanup</a></li><li><a href=#-final-thoughts>💭 final thoughts</a></li></ul></nav></div><div class=post_body><p>While Kubernetes is now the de-facto platform for orchestrating stateless applications (Because containers don't store data they can be destroyed and recreated elsewhere), running applications that require to persist data in an ephemeral environment can be <strong>quite challenging</strong>. We're seing increasing number of mature cloud-native database solutions (CockroachDB, TiDB, K8ssandra, Strimzi...) but there are a few <strong>things to consider</strong>:</p><ul><li>Maturity of the operator, declarative approach through CRDs.</li><li>How to handle the storage: Kubernetes volume management(CSI,PVCs), hdd vs ssd, local storage</li><li>Resiliency. What happens when something goes wrong?</li><li>Backup / Recovery. How easy is it? Scheduled backups</li><li>Replication / Scaling</li><li>Connection Pooling</li><li>Observability</li></ul><p>I was looking for a solution to host a <strong>PostgreSQL database</strong>. This database is a requirement for a ticket reservation software named <a href=https://alf.io/>Alf.io</a> that's being used for an upcoming event: <a href=https://kcdfrance.fr>The Kubernetes Community Days France</a>. (By the way you're welcome to submit a talk 👐, the <a href=https://cfp.kcdfrance.fr>CFP</a> closes soon).</p><p>I considered several solutions but I was looking for a cloud agnostic and easy solution. I already played with several Kubernetes operators and I finally ended up looking at a new kid on the block: <a href=https://cloudnative-pg.io/><strong>CloudNativePG</strong></a></p><blockquote><p>CloudNativePG is the Kubernetes operator that covers the full lifecycle of a highly available PostgreSQL database cluster with a primary/standby architecture, using native streaming replication.</p></blockquote><p>It has been submitted by the company <a href=https://www.enterprisedb.com/>EnterpriseDB</a> to the <strong>CNCF</strong> in order to join the <em>Sandbox</em> projects.</p><h2 id=-our-target>🎯 Our target</h2><p>Here I'm gonna try to give an <strong>introduction</strong> of the main CloudNativePG features.
Basically the idea is to create a PostgreSQL database on a GKE cluster.
Then we'll add a standby instance and we'll run a few resiliency tests.
We may want to see how it behaves in terms of performances and what are the observability tools available.
Finally we'll have a look to the backup/restore methods.</p><div class="notices info"><div class=label>Info</div><p>All the steps in this article will be made manually but you should consider using a <strong>GitOps</strong> engine.
Using Flux to manage everything has been covered in a <a href=/post/deflux/>previous article</a>.</p><p>You may want to check a complete <strong>example</strong> that I built for my own use case <a href=https://github.com/cncfparis/kcdfrance-gitops>here</a>.</p><p>All the manifests below can be found in <a href=https://github.com/Smana/smana.github.io/tree/main/content/resources/cnpg>this repository</a>.</p></div><h2 id=-requirements>☑️ Requirements</h2><h3 id=-install-required-tools>📥 Install required tools</h3><ul><li><strong>kubectl plugin:</strong> CloudNativePG comes with a handy <code>kubectl</code> plugin that gives insights of your PostgreSQL instance and allows to perform some operations.
It can be installed using <a href=https://krew.sigs.k8s.io/>krew</a> as follows</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>kubectl krew install cnpg
</span></span></span></code></pre></div><ul><li><strong>gcloud:</strong> As this article is about running it in Google Cloud, you'll need to install the Google Cloud SDK using <a href=https://cloud.google.com/sdk/docs/install-sdk>this documentation</a> and configure it in order to be able to create resources on your own GCP project.</li></ul><h3 id=-create-the-google-cloud-requirements>☁️ Create the Google cloud requirements</h3><p>There are a few things to configure before creating a PostgreSQL instance:</p><ul><li>Obviously you'll need a Kubernetes cluster. This article assumes that you already have a <strong>GKE</strong> cluster available.</li><li>We'll create a bucket which stores the backups and <a href=https://www.postgresql.org/docs/15/wal-intro.html>WAL files</a></li><li>Then we need to give the <strong>permissions</strong> to our pods so that they'll be able to write into this newly created bucket.</li></ul><p>Create the bucket using <code>gcloud</code> CLI</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln> 1</span><span class=cl><span class=go>gcloud storage buckets create --location=eu --default-storage-class=coldline gs://cnpg-ogenki
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=go>Creating gs://cnpg-ogenki/...
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=err></span><span class=go>gcloud storage buckets describe gs://cnpg-ogenki
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=go>[...]
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=go>name: cnpg-ogenki
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=go>owner:
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=go>  entity: project-owners-xxxx0008
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=go>projectNumber: &#39;xxx00008&#39;
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=go>rpo: DEFAULT
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=go>selfLink: https://www.googleapis.com/storage/v1/b/cnpg-ogenki
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=go>storageClass: STANDARD
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=go>timeCreated: &#39;2022-10-15T19:27:54.364000+00:00&#39;
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=go>updated: &#39;2022-10-15T19:27:54.364000+00:00&#39;
</span></span></span></code></pre></div><p>Give the permissions to the pods (PostgreSQL server) to write/read from the bucket using <a href=https://cloud.google.com/kubernetes-engine/docs/how-to/workload-identity><strong>Workload Identity</strong></a>.</p><div class="notices note"><div class=label>Note</div><p>The GKE cluster should be configured with <em>Workload Identity</em> enabled.
Check your cluster configuration, you should get something with this command:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>gcloud container clusters describe &lt;cluster_name&gt; --format json --zone &lt;zone&gt; | jq .workloadIdentityConfig
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go>{
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=go>  &#34;workloadPool&#34;: &#34;{{ gcp_project }}.svc.id.goog&#34;
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=go>}
</span></span></span></code></pre></div></div><p>Create a Google Cloud service account</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>gcloud iam service-accounts create cloudnative-pg --project={{ gcp_project }}
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go>Created service account [cloudnative-pg].
</span></span></span></code></pre></div><p>Assign the <code>storage.admin</code> permission to the serviceaccount</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>gcloud projects add-iam-policy-binding {{ gcp_project }} \
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go>--member &#34;serviceAccount:cloudnative-pg@{{ gcp_project }}.iam.gserviceaccount.com&#34; \
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=go>--role &#34;roles/storage.admin&#34;
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=go>[...]
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=go>- members:
</span></span></span><span class=line><span class=ln>6</span><span class=cl><span class=go>  - serviceAccount:cloudnative-pg@{{ gcp_project }}.iam.gserviceaccount.com
</span></span></span><span class=line><span class=ln>7</span><span class=cl><span class=go>  role: roles/storage.admin
</span></span></span><span class=line><span class=ln>8</span><span class=cl><span class=go>etag: BwXrGA_VRd4=
</span></span></span><span class=line><span class=ln>9</span><span class=cl><span class=go>version: 1
</span></span></span></code></pre></div><p>Allow the Kubernetes service account to <strong>impersonate the IAM service account</strong>.<br>ℹ️ ensure you use the proper format <code>serviceAccount:{{ gcp_project }}.svc.id.goog[{{ kubernetes_namespace }}/{{ kubernetes_serviceaccount }}]</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>gcloud iam service-accounts add-iam-policy-binding cloudnative-pg@{{ gcp_project }}.iam.gserviceaccount.com \
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go>--role roles/iam.workloadIdentityUser --member &#34;serviceAccount:{{ gcp_project }}.svc.id.goog[demo/ogenki]&#34;
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=go>Updated IAM policy for serviceAccount [cloudnative-pg@{{ gcp_project }}.iam.gserviceaccount.com].
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=go>bindings:
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=go>- members:
</span></span></span><span class=line><span class=ln>6</span><span class=cl><span class=go>  - serviceAccount:{{ gcp_project }}.svc.id.goog[demo/ogenki]
</span></span></span><span class=line><span class=ln>7</span><span class=cl><span class=go>  role: roles/iam.workloadIdentityUser
</span></span></span><span class=line><span class=ln>8</span><span class=cl><span class=go>etag: BwXrGBjt5kQ=
</span></span></span><span class=line><span class=ln>9</span><span class=cl><span class=go>version: 1
</span></span></span></code></pre></div><p>We're ready to create the Kubernetes resources 💪</p><h3 id=-create-the-users-secrets>🔑 Create the users secrets</h3><p>We need to create the users credentials that will be used during the bootstrap process (more info later on): The superuser and the newly created database owner.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>kubectl create secret generic cnpg-mydb-superuser --from-literal=username=postgres --from-literal=password=foobar --namespace demo
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go>secret/cnpg-mydb-superuser created
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>kubectl create secret generic cnpg-mydb-user --from-literal=username=smana --from-literal=password=barbaz --namespace demo
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go>secret/cnpg-mydb-user created
</span></span></span></code></pre></div><h2 id=-deploy-the-cloudnativepg-operator-using-helm>🛠️ Deploy the CloudNativePG operator using Helm</h2><p>CloudNativePG is basically a Kubernetes operator which comes with some CRD's. We'll use the Helm chart as follows</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>helm repo add cnpg https://cloudnative-pg.github.io/charts
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=err></span><span class=go>helm upgrade --install cnpg --namespace cnpg-system \
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=go>--create-namespace charts/cloudnative-pg
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=ln>6</span><span class=cl><span class=err></span><span class=go>kubectl get po -n cnpg-system
</span></span></span><span class=line><span class=ln>7</span><span class=cl><span class=go>NAME                    READY   STATUS      RESTARTS   AGE
</span></span></span><span class=line><span class=ln>8</span><span class=cl><span class=go>cnpg-74488f5849-8lhjr   1/1     Running     0          6h17m
</span></span></span></code></pre></div><p>Here are the <em>Custom Resource Definitions</em> installed along with the operator.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>kubectl get crds | grep cnpg.io
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go>backups.postgresql.cnpg.io                       2022-10-08T16:15:14Z
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=go>clusters.postgresql.cnpg.io                      2022-10-08T16:15:14Z
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=go>poolers.postgresql.cnpg.io                       2022-10-08T16:15:14Z
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=go>scheduledbackups.postgresql.cnpg.io              2022-10-08T16:15:14Z
</span></span></span></code></pre></div><p>For a full list of the available parameters for these CRDs please refer to the <a href=https://cloudnative-pg.io/documentation/1.17/api_reference/>API reference</a>.</p><br><h2 id=-create-a-postgresql-server>🚀 Create a PostgreSQL server</h2><center><img src=single_instance.png alt=single_instance width=600></center><p>Now we can create our first instance using a <strong>custom resource</strong> <code>Cluster</code>. The following definition is pretty simple: we want to start a PostgreSQL server, automatically create a database named <code>mydb</code> and configure the credentials based on the <a href=#key-create-the-users-secrets>secrets created previously</a>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=ln> 1</span><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>postgresql.cnpg.io/v1</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Cluster</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ogenki</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>demo</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>  </span><span class=nt>description</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;PostgreSQL Demo Ogenki&#34;</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>  </span><span class=nt>imageName</span><span class=p>:</span><span class=w> </span><span class=l>ghcr.io/cloudnative-pg/postgresql:14.5</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>  </span><span class=nt>instances</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>  </span><span class=nt>inheritedMetadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>    </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>      </span><span class=nt>iam.gke.io/gcp-service-account</span><span class=p>:</span><span class=w> </span><span class=l>cloudnative-pg@{{ gcp_project }}.iam.gserviceaccount.com</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>  </span><span class=nt>bootstrap</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>    </span><span class=nt>initdb</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>      </span><span class=nt>database</span><span class=p>:</span><span class=w> </span><span class=l>mydb</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>      </span><span class=nt>owner</span><span class=p>:</span><span class=w> </span><span class=l>smana</span><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>      </span><span class=nt>secret</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cnpg-mydb-user</span><span class=w>
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=w>  </span><span class=nt>superuserSecret</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>23</span><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cnpg-mydb-superuser</span><span class=w>
</span></span></span><span class=line><span class=ln>24</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>25</span><span class=cl><span class=w>  </span><span class=nt>storage</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>26</span><span class=cl><span class=w>    </span><span class=nt>storageClass</span><span class=p>:</span><span class=w> </span><span class=l>standard</span><span class=w>
</span></span></span><span class=line><span class=ln>27</span><span class=cl><span class=w>    </span><span class=nt>size</span><span class=p>:</span><span class=w> </span><span class=l>10Gi</span><span class=w>
</span></span></span><span class=line><span class=ln>28</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>29</span><span class=cl><span class=w>  </span><span class=nt>backup</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>30</span><span class=cl><span class=w>    </span><span class=nt>barmanObjectStore</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>31</span><span class=cl><span class=w>      </span><span class=nt>destinationPath</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;gs://cnpg-ogenki&#34;</span><span class=w>
</span></span></span><span class=line><span class=ln>32</span><span class=cl><span class=w>      </span><span class=nt>googleCredentials</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>33</span><span class=cl><span class=w>        </span><span class=nt>gkeEnvironment</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=ln>34</span><span class=cl><span class=w>    </span><span class=nt>retentionPolicy</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;30d&#34;</span><span class=w>
</span></span></span><span class=line><span class=ln>35</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>36</span><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>37</span><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>38</span><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1Gi&#34;</span><span class=w>
</span></span></span><span class=line><span class=ln>39</span><span class=cl><span class=w>      </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;500m&#34;</span><span class=w>
</span></span></span><span class=line><span class=ln>40</span><span class=cl><span class=w>    </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>41</span><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1Gi&#34;</span><span class=w>
</span></span></span></code></pre></div><p>Create the namespace where our PostgreSQL instance will be deployed</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>kubectl create ns demo
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go>namespace/demo created
</span></span></span></code></pre></div><p>Change the above cluster manifest to fit your needs and apply it.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>kubectl apply -f cluster.yaml
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go>cluster.postgresql.cnpg.io/ogenki created
</span></span></span></code></pre></div><p>You'll notice that the cluster will be in <em>initializing</em> phase. Let's use the <strong>cnpg plugin</strong> for the first time, it will become our best friend to display a neat view of the cluster's status.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln> 1</span><span class=cl><span class=go>kubectl cnpg status ogenki -n demo
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=go>Cluster Summary
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=go>Primary server is initializing
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=go>Name:              ogenki
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=go>Namespace:         demo
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=go>PostgreSQL Image:  ghcr.io/cloudnative-pg/postgresql:14.5
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=go>Primary instance:   (switching to ogenki-1)
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=go>Status:            Setting up primary Creating primary instance ogenki-1
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=go>Instances:         1
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=go>Ready instances:   0
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=err></span><span class=go>Certificates Status
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=go>Certificate Name    Expiration Date                Days Left Until Expiration
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=go>----------------    ---------------                --------------------------
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=go>ogenki-ca           2023-01-13 20:02:40 +0000 UTC  90.00
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=go>ogenki-replication  2023-01-13 20:02:40 +0000 UTC  90.00
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=go>ogenki-server       2023-01-13 20:02:40 +0000 UTC  90.00
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=err></span><span class=go>Continuous Backup status
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=go>First Point of Recoverability:  Not Available
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=go>No Primary instance found
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=go>Streaming Replication status
</span></span></span><span class=line><span class=ln>23</span><span class=cl><span class=go>Not configured
</span></span></span><span class=line><span class=ln>24</span><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=ln>25</span><span class=cl><span class=err></span><span class=go>Instances status
</span></span></span><span class=line><span class=ln>26</span><span class=cl><span class=go>Name  Database Size  Current LSN  Replication role  Status  QoS  Manager Version  Node
</span></span></span><span class=line><span class=ln>27</span><span class=cl><span class=go>----  -------------  -----------  ----------------  ------  ---  ---------------  ----
</span></span></span></code></pre></div><p>The first thing that runs under the hood is the <strong>bootstrap</strong> process. In our example we create a brand new database named <code>mydb</code> with an owner <code>smana</code> and credentials are retrieved from the secret we created previously.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=ln>1</span><span class=cl><span class=p>[</span><span class=l>...]</span><span class=w>
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=w>  </span><span class=nt>bootstrap</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=w>    </span><span class=nt>initdb</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=w>      </span><span class=nt>database</span><span class=p>:</span><span class=w> </span><span class=l>mydb</span><span class=w>
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=w>      </span><span class=nt>owner</span><span class=p>:</span><span class=w> </span><span class=l>smana</span><span class=w>
</span></span></span><span class=line><span class=ln>6</span><span class=cl><span class=w>      </span><span class=nt>secret</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>7</span><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cnpg-mydb-user</span><span class=w>
</span></span></span><span class=line><span class=ln>8</span><span class=cl><span class=w></span><span class=p>[</span><span class=l>...]</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>kubectl get po -n demo
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go>NAME                    READY   STATUS      RESTARTS   AGE
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=go>ogenki-1                0/1     Running     0          55s
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=go>ogenki-1-initdb-q75cz   0/1     Completed   0          2m32s
</span></span></span></code></pre></div><p>After a few seconds the cluster becomes ready 👏</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln> 1</span><span class=cl><span class=go>kubectl cnpg status ogenki -n demo
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=go>Cluster Summary
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=go>Name:               ogenki
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=go>Namespace:          demo
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=go>System ID:          7154833472216277012
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=go>PostgreSQL Image:   ghcr.io/cloudnative-pg/postgresql:14.5
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=go>Primary instance:   ogenki-1
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=go>Status:             Cluster in healthy state
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=go>Instances:          1
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=go>Ready instances:    1
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=err></span><span class=go>[...]
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=err></span><span class=go>Instances status
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=go>Name      Database Size  Current LSN  Replication role  Status  QoS        Manager Version  Node
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=go>----      -------------  -----------  ----------------  ------  ---        ---------------  ----
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=go>ogenki-1  33 MB          0/17079F8    Primary           OK      Burstable  1.17.0           gke-kcdfrance-main-np-0e87115b-xczh
</span></span></span></code></pre></div><div class="notices info"><div class=label>Info</div><p>There are many ways of bootstrapping your cluster. For instance, restoring a backup into a brand new instance, running SQL scripts...
more info <a href=https://cloudnative-pg.io/documentation/1.17/bootstrap/>here</a>.</p></div><div class="notices note"><div class=label>Note</div><p>This is possible because we gave the permissions using an annotation in the pod's serviceaccount</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>kubectl get sa -n demo ogenki -o yaml | grep gcp-service-account
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go>    iam.gke.io/gcp-service-account: cloudnative-pg@{{ gcp_project }}.iam.gserviceaccount.com
</span></span></span></code></pre></div><p>I proposed a <a href=https://github.com/cloudnative-pg/cloudnative-pg/pull/836>PR</a> in order to update the documentation with this information.</p></div><h2 id=-standby-instance-and-resiliency>🩹 Standby instance and resiliency</h2><div class="notices info"><div class=label>Info</div><p>In traditional PostgreSQL architectures we commonly find an additional component to handle high availability (e.g. <a href=https://patroni.readthedocs.io/en/latest/>Patroni</a>). A specific aspect of the CloudNativePG operator is that it leverages base Kubernetes features and relies on a component named <a href=https://cloudnative-pg.io/documentation/1.17/instance_manager/><em>Postgres instance manager</em></a>.</p></div><p>Add a standby instance by setting up the number of replicas to 2.</p><center><img src=standby.png alt=standby width=600></center><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>kubectl edit cluster -n demo ogenki
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go>cluster.postgresql.cnpg.io/ogenki edited
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=ln>1</span><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>postgresql.cnpg.io/v1</span><span class=w>
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Cluster</span><span class=w>
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=w></span><span class=p>[</span><span class=l>...]</span><span class=w>
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=w>  </span><span class=nt>instances</span><span class=p>:</span><span class=w> </span><span class=m>2</span><span class=w>
</span></span></span><span class=line><span class=ln>6</span><span class=cl><span class=w></span><span class=p>[</span><span class=l>...]</span><span class=w>
</span></span></span></code></pre></div><p>The operator immediately notice the change, adds a standby instance and starts the replication process.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln> 1</span><span class=cl><span class=go>kubectl cnpg status -n demo ogenki
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=go>Cluster Summary
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=go>Name:               ogenki
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=go>Namespace:          demo
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=go>System ID:          7155095145869606932
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=go>PostgreSQL Image:   ghcr.io/cloudnative-pg/postgresql:14.5
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=go>Primary instance:   ogenki-1
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=go>Status:             Creating a new replica Creating replica ogenki-2-join
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=go>Instances:          2
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=go>Ready instances:    1
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=go>Current Write LSN:  0/1707A30 (Timeline: 1 - WAL File: 000000010000000000000001)
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>kubectl get po -n demo
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go>NAME                  READY   STATUS    RESTARTS   AGE
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=go>ogenki-1              1/1     Running   0          3m16s
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=go>ogenki-2-join-xxrwx   0/1     Pending   0          82s
</span></span></span></code></pre></div><p>After a given time, depending on the amount of data to replicate, the standby instance will be up and running and we can see the replication statistics.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln> 1</span><span class=cl><span class=go>kubectl cnpg status -n demo ogenki
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=go>Cluster Summary
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=go>Name:               ogenki
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=go>Namespace:          demo
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=go>System ID:          7155095145869606932
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=go>PostgreSQL Image:   ghcr.io/cloudnative-pg/postgresql:14.5
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=go>Primary instance:   ogenki-1
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=go>Status:             Cluster in healthy state
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=go>Instances:          2
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=go>Ready instances:    2
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=go>Current Write LSN:  0/3000060 (Timeline: 1 - WAL File: 000000010000000000000003)
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=err></span><span class=go>[...]
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=err></span><span class=go>Streaming Replication status
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=go>Name      Sent LSN   Write LSN  Flush LSN  Replay LSN  Write Lag  Flush Lag  Replay Lag  State      Sync State  Sync Priority
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=go>----      --------   ---------  ---------  ----------  ---------  ---------  ----------  -----      ----------  -------------
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=go>ogenki-2  0/3000060  0/3000060  0/3000060  0/3000060   00:00:00   00:00:00   00:00:00    streaming  async       0
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=err></span><span class=go>Instances status
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=go>Name      Database Size  Current LSN  Replication role  Status  QoS        Manager Version  Node
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=go>----      -------------  -----------  ----------------  ------  ---        ---------------  ----
</span></span></span><span class=line><span class=ln>23</span><span class=cl><span class=go>ogenki-1  33 MB          0/3000060    Primary           OK      Burstable  1.17.0           gke-kcdfrance-main-np-0e87115b-76k7
</span></span></span><span class=line><span class=ln>24</span><span class=cl><span class=go>ogenki-2  33 MB          0/3000060    Standby (async)   OK      Burstable  1.17.0           gke-kcdfrance-main-np-0e87115b-xszc
</span></span></span></code></pre></div><p>Let's promote the standby instance to primary (perform a <strong><em>Switchover</em></strong>).</p><center><img src=promote.png alt=promote width=600></center><p>The <code>cnpg</code> plugin allows to do this imperatively by running this command</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>kubectl cnpg promote ogenki ogenki-2 -n demo
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go>Node ogenki-2 in cluster ogenki will be promoted
</span></span></span></code></pre></div><p>In my case the switchover was really fast. We can check that the instance <code>ogenki-2</code> is now the primary and the replication is done the other way round.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln> 1</span><span class=cl><span class=go>kubectl cnpg status -n demo ogenki
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=go>[...]
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=go>Status:             Switchover in progress Switching over to ogenki-2
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=go>Instances:          2
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=go>Ready instances:    1
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=go>[...]
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=go>Streaming Replication status
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=go>Name      Sent LSN   Write LSN  Flush LSN  Replay LSN  Write Lag  Flush Lag  Replay Lag  State      Sync State  Sync Priority
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=go>----      --------   ---------  ---------  ----------  ---------  ---------  ----------  -----      ----------  -------------
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=go>ogenki-1  0/4004CA0  0/4004CA0  0/4004CA0  0/4004CA0   00:00:00   00:00:00   00:00:00    streaming  async       0
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=err></span><span class=go>Instances status
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=go>Name      Database Size  Current LSN  Replication role  Status  QoS        Manager Version  Node
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=go>----      -------------  -----------  ----------------  ------  ---        ---------------  ----
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=go>ogenki-2  33 MB          0/4004CA0    Primary           OK      Burstable  1.17.0           gke-kcdfrance-main-np-0e87115b-xszc
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=go>ogenki-1  33 MB          0/4004CA0    Standby (async)   OK      Burstable  1.17.0           gke-kcdfrance-main-np-0e87115b-76k7
</span></span></span></code></pre></div><p>Now let's simulate a <strong><em>Failover</em></strong> by deleting the primary pod</p><center><img src=failover.png alt=failover width=600></center><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>kubectl delete po -n demo --grace-period 0 --force ogenki-2
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go>Warning: Immediate deletion does not wait for confirmation that the running resource has been terminated. The resource may continue to run on the cluster indefinitely.
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=go>pod &#34;ogenki-2&#34; force deleted
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln> 1</span><span class=cl><span class=go>Cluster Summary
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=go>Name:               ogenki
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=go>Namespace:          demo
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=go>System ID:          7155095145869606932
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=go>PostgreSQL Image:   ghcr.io/cloudnative-pg/postgresql:14.5
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=go>Primary instance:   ogenki-1
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=go>Status:             Failing over Failing over from ogenki-2 to ogenki-1
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=go>Instances:          2
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=go>Ready instances:    1
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=go>Current Write LSN:  0/4005D98 (Timeline: 3 - WAL File: 000000030000000000000004)
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=err></span><span class=go>[...]
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=go>Instances status
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=go>Name      Database Size  Current LSN  Replication role  Status             QoS        Manager Version  Node
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=go>----      -------------  -----------  ----------------  ------             ---        ---------------  ----
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=go>ogenki-1  33 MB          0/40078D8    Primary           OK                 Burstable  1.17.0           gke-kcdfrance-main-np-0e87115b-76k7
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=go>ogenki-2  -              -            -                 pod not available  Burstable  -                gke-kcdfrance-main-np-0e87115b-xszc
</span></span></span></code></pre></div><p>After a few seconds, the cluster becomes healthy again</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>kubectl get cluster -n demo
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go>NAME     AGE   INSTANCES   READY   STATUS                     PRIMARY
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=go>ogenki   13m   2           2       Cluster in healthy state   ogenki-1
</span></span></span></code></pre></div><p>So far so good, we've been able to test the high availability and the experience is pretty smooth 😎.</p><h2 id=-monitoring>👁️ Monitoring</h2><p>I won't cover the <a href=https://github.com/prometheus-operator/kube-prometheus>Prometheus Stack</a> installation in this article. If you wan't to have a look on how to do this the Gitops way please check <a href=https://github.com/Smana/kcdfrance-gitops/tree/main/observability>this example</a>.</p><p>Basically we need to create a <em>PodMonitor</em> in order to scrape our instance's metrics.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=ln> 1</span><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>monitoring.coreos.com/v1</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>PodMonitor</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>  </span><span class=nt>labels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>    </span><span class=nt>prometheus-instance</span><span class=p>:</span><span class=w> </span><span class=l>main</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cnpg-ogenki</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>demo</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>  </span><span class=nt>namespaceSelector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>    </span><span class=nt>matchNames</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>    </span>- <span class=l>demo</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>  </span><span class=nt>podMetricsEndpoints</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>  </span>- <span class=nt>port</span><span class=p>:</span><span class=w> </span><span class=l>metrics</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>  </span><span class=nt>selector</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>    </span><span class=nt>matchLabels</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>      </span><span class=nt>postgresql</span><span class=p>:</span><span class=w> </span><span class=l>ogenki</span><span class=w>
</span></span></span></code></pre></div><p>And the Grafana dashboard available <a href=https://github.com/EnterpriseDB/cnp-sandbox/blob/main/charts/cnp-sandbox/dashboard.json>here</a>.</p><p><figure><picture><img loading=lazy decoding=async alt=observability class="image_figure image_internal image_processed" width=2528 height=1456 src=/post/cnpg/observability.png></picture></figure></p><p>Finally, you may want to configure alerts and you can create a <em>PrometheusRule</em> using <a href=https://github.com/EnterpriseDB/cnp-sandbox/blob/main/charts/cnp-sandbox/alerts.yaml>these rules</a></p><h2 id=-performances-and-benchmark>🔥 Performances and benchmark</h2><p>This is worth running a <strong>performance test</strong> in order to know the limits of your current server and keep a baseline for further improvements.</p><div class="notices note"><div class=label>Note</div><p>When it comes to performances there are many improvement areas we can work on. It mostly depends on the <strong>target</strong> we want to achieve. Indeed we don't want to waste time and money for performances we likely never need.</p><p>Here are the main things to look at:</p><ul><li>PostgreSQL <a href=https://wiki.postgresql.org/wiki/Tuning_Your_PostgreSQL_Server>configuration tuning</a></li><li><strong>Compute</strong> resources (cpu and memory)</li><li><strong>Disk</strong> type IOPS, local storage (<a href=https://docs.pingcap.com/tidb-in-kubernetes/stable/deploy-on-gcp-gke#use-local-storage>local-volume-provisioner</a>),</li><li>Dedicated disks for <strong>WAL</strong> and <strong>PG_DATA</strong></li><li>Connection <strong>pooling</strong> <a href=https://cloudnative-pg.io/documentation/1.17/connection_pooling/#connection-pooling>PGBouncer</a>. The CloudNativePG comes with a CRD <code>Pooler</code> to handle that.</li><li>Database optimization, analyzing the query plans using <a href=https://www.postgresql.org/docs/current/performance-tips.html><strong>explain</strong></a>, use the extension <code>pg_stat_statement</code> ...</li></ul></div><center><img src=pgbench.png alt=standby width=600></center><p>First of all we'll add labels to the nodes in order to run the <code>pgbench</code> command on different machines than the ones hosting the database.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>PG_NODE=$(kubectl get po -n demo -l postgresql=ogenki,role=primary -o jsonpath={.items[0].spec.nodeName})
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go>kubectl label node ${PG_NODE} workload=postgresql
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=go>node/gke-kcdfrance-main-np-0e87115b-vlzm labeled
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=err>
</span></span></span><span class=line><span class=ln>6</span><span class=cl><span class=err></span><span class=gp>#</span> Choose any other node different than the <span class=si>${</span><span class=nv>PG_NODE</span><span class=si>}</span>
</span></span><span class=line><span class=ln>7</span><span class=cl><span class=go>kubectl label node gke-kcdfrance-main-np-0e87115b-p5d7 workload=pgbench
</span></span></span><span class=line><span class=ln>8</span><span class=cl><span class=go>node/gke-kcdfrance-main-np-0e87115b-p5d7 labeled
</span></span></span></code></pre></div><p>And we'll deploy the Helm chart as follows</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln> 1</span><span class=cl><span class=go>git clone git@github.com:EnterpriseDB/cnp-bench.git
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=go>cd cnp-bench
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=err></span><span class=go>cat &gt; pgbench-benchmark/myvalues.yaml &lt;&lt;EOF
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=go>cnp:
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=go>  existingCluster: true
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=go>  existingHost:  ogenki-rw
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=go>  existingCredentials: cnpg-mydb-superuser
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=go>  existingDatabase: mydb
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=err></span><span class=go>pgbench:
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=go>  # Node where to run pgbench
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=go>  nodeSelector:
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=go>    workload: pgbench
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=go>  initialize: true
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=go>  scaleFactor: 1
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=go>  time: 600
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=go>  clients: 10
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=go>  jobs: 1
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=go>  skipVacuum: false
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=go>  reportLatencies: false
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=go>EOF
</span></span></span><span class=line><span class=ln>23</span><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=ln>24</span><span class=cl><span class=err></span><span class=go>helm upgrade --install -n demo pgbench -f pgbench-benchmark/myvalues.yaml  pgbench-benchmark/
</span></span></span></code></pre></div><div class="notices info"><div class=label>Info</div><p>There are different services depending on wether you want to read and <strong>write</strong> or <strong>read only</strong>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>kubectl get ep -n demo
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go>NAME        ENDPOINTS                          AGE
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=go>ogenki-any   10.64.1.136:5432,10.64.1.3:5432    15d
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=go>ogenki-r     10.64.1.136:5432,10.64.1.3:5432    15d
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=go>ogenki-ro    10.64.1.136:5432                   15d
</span></span></span><span class=line><span class=ln>6</span><span class=cl><span class=go>ogenki-rw    10.64.1.3:5432                     15d
</span></span></span></code></pre></div></div><p><figure><picture><img loading=lazy decoding=async alt=pgbench_grafana class="image_figure image_internal image_processed" width=2326 height=1730 src=/post/cnpg/pgbench_grafana.png></picture></figure></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln> 1</span><span class=cl><span class=go>kubectl logs -n demo job/pgbench-pgbench-benchmark -f
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=go>Defaulted container &#34;pgbench&#34; out of: pgbench, wait-for-cnp (init), pgbench-init (init)
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=go>pgbench (14.1, server 14.5 (Debian 14.5-2.pgdg110+2))
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=go>starting vacuum...end.
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=go>transaction type: &lt;builtin: TPC-B (sort of)&gt;
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=go>scaling factor: 1
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=go>query mode: simple
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=go>number of clients: 10
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=go>number of threads: 1
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=go>duration: 600 s
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=go>number of transactions actually processed: 545187
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=go>latency average = 11.004 ms
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=go>initial connection time = 111.585 ms
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=go>tps = 908.782896 (without initial connection time)
</span></span></span></code></pre></div><h2 id=-backup-and-restore>💽 Backup and Restore</h2><p>We can first trigger an <strong>ondemand</strong> backup using the custom resource <code>Backup</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=ln>1</span><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>postgresql.cnpg.io/v1</span><span class=w>
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Backup</span><span class=w>
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ogenki-now</span><span class=w>
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>demo</span><span class=w>
</span></span></span><span class=line><span class=ln>6</span><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>7</span><span class=cl><span class=w>  </span><span class=nt>cluster</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>8</span><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ogenki</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>kubectl apply -f backup.yaml
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go>backup.postgresql.cnpg.io/ogenki-now created
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=err></span><span class=go>kubectl get backup -n demo
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=go>NAME                      AGE   CLUSTER   PHASE       ERROR
</span></span></span><span class=line><span class=ln>6</span><span class=cl><span class=go>ogenki-now                36s   ogenki    completed
</span></span></span></code></pre></div><p>If you take a look at the Google Cloud Storage content you'll see an new directory that stores the <strong>base backups</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>gcloud storage ls gs://cnpg-ogenki/ogenki/base
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go>gs://cnpg-ogenki/ogenki/base/20221023T130327/
</span></span></span></code></pre></div><p>But most of the time we would want to have a <strong>scheduled backup</strong>. So let's configure a daily schedule.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=ln> 1</span><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>postgresql.cnpg.io/v1</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>ScheduledBackup</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ogenki-daily</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>demo</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>  </span><span class=nt>backupOwnerReference</span><span class=p>:</span><span class=w> </span><span class=l>self</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>  </span><span class=nt>cluster</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ogenki</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>  </span><span class=nt>schedule</span><span class=p>:</span><span class=w> </span><span class=m>0</span><span class=w> </span><span class=m>0</span><span class=w> </span><span class=m>0</span><span class=w> </span>*<span class=w> </span>*<span class=w> </span>*<span class=w>
</span></span></span></code></pre></div><p>Recoveries can only be done on new instances. Here we'll use the backup we've created previously to bootstrap a new instance with it.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln> 1</span><span class=cl><span class=go>gcloud iam service-accounts add-iam-policy-binding cloudnative-pg@{{ gcp_project }}.iam.gserviceaccount.com \
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=go>--role roles/iam.workloadIdentityUser --member &#34;serviceAccount:{{ gcp_project }}.svc.id.goog[demo/ogenki-restore]&#34;
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=go>Updated IAM policy for serviceAccount [cloudnative-pg@{{ gcp_project }}.iam.gserviceaccount.com].
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=go>bindings:
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=go>- members:
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=go>  - serviceAccount:{{ gcp_project }}.svc.id.goog[demo/ogenki-restore]
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=go>  - serviceAccount:{{ gcp_project }}.svc.id.goog[demo/ogenki]
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=go>  role: roles/iam.workloadIdentityUser
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=go>etag: BwXrs755FPA=
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=go>version: 1
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=ln> 1</span><span class=cl><span class=nt>apiVersion</span><span class=p>:</span><span class=w> </span><span class=l>postgresql.cnpg.io/v1</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w></span><span class=nt>kind</span><span class=p>:</span><span class=w> </span><span class=l>Cluster</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w></span><span class=nt>metadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>  </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ogenki-restore</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>  </span><span class=nt>namespace</span><span class=p>:</span><span class=w> </span><span class=l>demo</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w></span><span class=nt>spec</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>  </span><span class=nt>instances</span><span class=p>:</span><span class=w> </span><span class=m>1</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>  </span><span class=nt>inheritedMetadata</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>    </span><span class=nt>annotations</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>      </span><span class=nt>iam.gke.io/gcp-service-account</span><span class=p>:</span><span class=w> </span><span class=l>cloudnative-pg@{{ gcp_project }}.iam.gserviceaccount.com</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>  </span><span class=nt>storage</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>    </span><span class=nt>storageClass</span><span class=p>:</span><span class=w> </span><span class=l>standard</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>    </span><span class=nt>size</span><span class=p>:</span><span class=w> </span><span class=l>10Gi</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>    </span><span class=nt>requests</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1Gi&#34;</span><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=w>      </span><span class=nt>cpu</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;500m&#34;</span><span class=w>
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=w>    </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1Gi&#34;</span><span class=w>
</span></span></span><span class=line><span class=ln>23</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>24</span><span class=cl><span class=w>  </span><span class=nt>superuserSecret</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>25</span><span class=cl><span class=w>    </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>cnpg-mydb-superuser</span><span class=w>
</span></span></span><span class=line><span class=ln>26</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>27</span><span class=cl><span class=w>  </span><span class=nt>bootstrap</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>28</span><span class=cl><span class=w>    </span><span class=nt>recovery</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>29</span><span class=cl><span class=w>      </span><span class=nt>backup</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>30</span><span class=cl><span class=w>        </span><span class=nt>name</span><span class=p>:</span><span class=w> </span><span class=l>ogenki-now</span><span class=w>
</span></span></span></code></pre></div><p>We can notice a first pod that performs the full recovery from the backup.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>kubectl get po -n demo
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go>NAME                                   READY   STATUS      RESTARTS      AGE
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=go>ogenki-1                               1/1     Running     1 (18h ago)   18h
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=go>ogenki-2                               1/1     Running     0             18h
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=go>ogenki-restore-1                       0/1     Init:0/1    0             0s
</span></span></span><span class=line><span class=ln>6</span><span class=cl><span class=go>ogenki-restore-1-full-recovery-5p4ct   0/1     Completed   0             51s
</span></span></span></code></pre></div><p>Then the new cluster becomes ready.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>kubectl get cluster -n demo
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go>NAME             AGE   INSTANCES   READY   STATUS                     PRIMARY
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=go>ogenki           18h   2           2       Cluster in healthy state   ogenki-1
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=go>ogenki-restore   80s   1           1       Cluster in healthy state   ogenki-restore-1
</span></span></span></code></pre></div><h2 id=-cleanup>🧹 Cleanup</h2><p>Delete the cluster</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>kubectl delete cluster -n demo ogenki ogenki-restore
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go>cluster.postgresql.cnpg.io &#34;ogenki&#34; deleted
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=go>cluster.postgresql.cnpg.io &#34;ogenki-restore&#34; deleted
</span></span></span></code></pre></div><p>Cleanup the IAM serviceaccount</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-console data-lang=console><span class=line><span class=ln>1</span><span class=cl><span class=go>gcloud iam service-accounts delete cloudnative-pg@{{ gcp_project }}.iam.gserviceaccount.com
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=go>You are about to delete service account [cloudnative-pg@{{ gcp_project }}.iam.gserviceaccount.com].
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=err></span><span class=go>Do you want to continue (Y/n)?  y
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=go></span><span class=err>
</span></span></span><span class=line><span class=ln>6</span><span class=cl><span class=err></span><span class=go>deleted service account [cloudnative-pg@{{ gcp_project }}.iam.gserviceaccount.com]
</span></span></span></code></pre></div><h2 id=-final-thoughts>💭 final thoughts</h2><p>I just discovered CloudNativePG and I just scratched the surface but one thing for sure is that managing PostgreSQL is really made <strong>easy</strong>.
However choosing a database solution is a <strong>though decision</strong>. Depending on the use case, the company constraints, the criticity of the application and the ops teams skills, there are plenty of options: Cloud managed databases, traditional baremetal installations, building the architecture with an Infrastructure As Code tool.</p><p>We may also consider using Crossplane and composition to give an opinionated way of declaring managed databases in cloud providers but that requires more configuration.</p><p>Again CloudNativePG shines by its simplicity, to run and to understand. Furthermore the <strong>documentation</strong> is one of the best I ever seen, especially for a so young open source project (Hopefuly it can help in the Sandbox acceptance process 🤞).</p><p>If you want to learn more about it, there will be a presentation on 27th of October at the <a href=https://kccncna2022.sched.com/event/182GB/data-on-kubernetes-deploying-and-running-postgresql-and-patterns-for-databases-in-a-kubernetes-cluster-chris-milsted-ondat-gabriele-bartolini-edb>KubeCon</a>.</p></div><div class=post_comments></div></article><aside class=sidebar><section class=sidebar_inner><br><div class=search><input type=search class="search_field form_field" placeholder=Search... id=find autocomplete=off data-scope=post>
<label for=find class=search_label><svg class="icon"><title>search</title><use xlink:href="#search"/></svg></label><div class="search_results results"></div></div><div class=author_header><img src=https://blog.ogenki.io/images/smana.jpg alt="Smaine Kahlouch photo"><h2>Smaine Kahlouch</h2></div><div class=author_bio>Lead SRE/DevOps, Cloud Native ambassador, Open Source enthusiast.</div><a href=https://blog.ogenki.io/about/ class="button mt-1" role=button title='Read More'>Read More</a><h2 class=mt-4>Featured Posts</h2><ul><li><a href=https://blog.ogenki.io/post/devflux/ class=nav-link title="100% `GitOps` using Flux">100% <code>GitOps</code> using Flux</a></li><li><a href=https://blog.ogenki.io/post/series/workshop_helm/intro/ class=nav-link title="Helm workshop">Helm workshop</a></li><li><a href=https://blog.ogenki.io/post/series/workshop_kubernetes/intro/ class=nav-link title="Kubernetes workshop">Kubernetes workshop</a></li></ul><h2 class=mt-4>Recent Posts</h2><ul class=flex-column><li><a href=https://blog.ogenki.io/post/devflux/ class=nav-link title="100% `GitOps` using Flux">100% <code>GitOps</code> using Flux</a></li><li><a href=https://blog.ogenki.io/post/crossplane_k3d/ class=nav-link title="My Kubernetes cluster (GKE) with `Crossplane`">My Kubernetes cluster (GKE) with <code>Crossplane</code></a></li><li><a href=https://blog.ogenki.io/post/asdf/asdf/ class=nav-link title="Manage tools versions with `asdf`">Manage tools versions with <code>asdf</code></a></li><li><a href=https://blog.ogenki.io/post/series/workshop_helm/templating/ class=nav-link title="Helm workshop: Templating exercises">Helm workshop: Templating exercises</a></li><li><a href=https://blog.ogenki.io/post/series/workshop_helm/build_chart/ class=nav-link title="Helm workshop: Build your first chart">Helm workshop: Build your first chart</a></li><li><a href=https://blog.ogenki.io/post/series/workshop_helm/lifecycle/ class=nav-link title="Helm workshop: Lifecycle operations">Helm workshop: Lifecycle operations</a></li><li><a href=https://blog.ogenki.io/post/series/workshop_helm/ecosystem/ class=nav-link title="Helm workshop: Ecosystem">Helm workshop: Ecosystem</a></li><li><a href=https://blog.ogenki.io/post/series/workshop_helm/third_party/ class=nav-link title="Helm workshop: Third party charts">Helm workshop: Third party charts</a></li></ul><div><h2 class="mt-4 taxonomy" id=categories-section>Categories</h2><nav class=tags_nav><a href=https://blog.ogenki.io/categories/containers/ class="post_tag button button_translucent" title=containers>CONTAINERS
<span class=button_tally>7</span></a>
<a href=https://blog.ogenki.io/categories/devxp/ class="post_tag button button_translucent" title=devxp>DEVXP
<span class=button_tally>6</span></a></nav></div><div><h2 class="mt-4 taxonomy" id=series-section>Series</h2><nav class=tags_nav><a href=https://blog.ogenki.io/series/workshop-kubernetes/ class="post_tag button button_translucent" title=workshop-kubernetes>WORKSHOP-KUBERNETES
<span class=button_tally>7</span></a>
<a href=https://blog.ogenki.io/series/workshop-helm/ class="post_tag button button_translucent" title=workshop-helm>WORKSHOP-HELM
<span class=button_tally>6</span></a></nav></div><div><h2 class="mt-4 taxonomy" id=tags-section>Tags</h2><nav class=tags_nav><a href=https://blog.ogenki.io/tags/kubernetes/ class="post_tag button button_translucent" title=kubernetes>KUBERNETES
<span class=button_tally>14</span></a>
<a href=https://blog.ogenki.io/tags/helm/ class="post_tag button button_translucent" title=helm>HELM
<span class=button_tally>6</span></a>
<a href=https://blog.ogenki.io/tags/data/ class="post_tag button button_translucent" title=data>DATA
<span class=button_tally>1</span></a>
<a href=https://blog.ogenki.io/tags/devxp/ class="post_tag button button_translucent" title=devxp>DEVXP
<span class=button_tally>1</span></a>
<a href=https://blog.ogenki.io/tags/gitops/ class="post_tag button button_translucent" title=gitops>GITOPS
<span class=button_tally>1</span></a>
<a href=https://blog.ogenki.io/tags/index/ class="post_tag button button_translucent" title=index>INDEX
<span class=button_tally>1</span></a>
<a href=https://blog.ogenki.io/tags/infrastructure/ class="post_tag button button_translucent" title=infrastructure>INFRASTRUCTURE
<span class=button_tally>1</span></a>
<a href=https://blog.ogenki.io/tags/local/ class="post_tag button button_translucent" title=local>LOCAL
<span class=button_tally>1</span></a>
<a href=https://blog.ogenki.io/tags/tooling/ class="post_tag button button_translucent" title=tooling>TOOLING
<span class=button_tally>1</span></a></nav></div></section></aside></div></main><svg width="0" height="0" class="hidden"><symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="facebook"><path d="M437 0H75C33.648.0.0 33.648.0 75v362c0 41.352 33.648 75 75 75h151V331h-60v-90h60v-61c0-49.629 40.371-90 90-90h91v90h-91v61h91l-15 90h-76v181h121c41.352.0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zm0 0"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18.001 18.001" id="twitter"><path d="M15.891 4.013c.808-.496 1.343-1.173 1.605-2.034a8.68 8.68.0 01-2.351.861c-.703-.756-1.593-1.14-2.66-1.14-1.043.0-1.924.366-2.643 1.078A3.56 3.56.0 008.766 5.383c0 .309.039.585.117.819-3.076-.105-5.622-1.381-7.628-3.837-.34.601-.51 1.213-.51 1.846.0 1.301.549 2.332 1.645 3.089-.625-.053-1.176-.211-1.645-.47.0.929.273 1.705.82 2.388a3.623 3.623.0 002.115 1.291c-.312.08-.641.118-.979.118-.312.0-.533-.026-.664-.083.23.757.664 1.371 1.291 1.841a3.652 3.652.0 002.152.743C4.148 14.173 2.625 14.69.902 14.69c-.422.0-.721-.006-.902-.038 1.697 1.102 3.586 1.649 5.676 1.649 2.139.0 4.029-.542 5.674-1.626 1.645-1.078 2.859-2.408 3.639-3.974a10.77 10.77.0 001.172-4.892v-.468a7.788 7.788.0 001.84-1.921 8.142 8.142.0 01-2.11.593z"/></symbol><symbol aria-hidden="true" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="mail"><path d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V4e2c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5.0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="calendar"><path d="M452 40h-24V0h-40v40H124V0H84v40H60C26.916 40 0 66.916.0 1e2v352c0 33.084 26.916 60 60 60h392c33.084.0 60-26.916 60-60V1e2c0-33.084-26.916-60-60-60zm20 412c0 11.028-8.972 20-20 20H60c-11.028.0-20-8.972-20-20V188h432v264zm0-304H40v-48c0-11.028 8.972-20 20-20h24v40h40V80h264v40h40V80h24c11.028.0 20 8.972 20 20v48z"/><path d="M76 230h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 310h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zM76 390h40v40H76zm80 0h40v40h-40zm80 0h40v40h-40zm80 0h40v40h-40zm80-80h40v40h-40z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="github"><path d="M255.968 5.329C114.624 5.329.0 120.401.0 262.353c0 113.536 73.344 209.856 175.104 243.872 12.8 2.368 17.472-5.568 17.472-12.384.0-6.112-.224-22.272-.352-43.712-71.2 15.52-86.24-34.464-86.24-34.464-11.616-29.696-28.416-37.6-28.416-37.6-23.264-15.936 1.728-15.616 1.728-15.616 25.696 1.824 39.2 26.496 39.2 26.496 22.848 39.264 59.936 27.936 74.528 21.344 2.304-16.608 8.928-27.936 16.256-34.368-56.832-6.496-116.608-28.544-116.608-127.008.0-28.064 9.984-51.008 26.368-68.992-2.656-6.496-11.424-32.64 2.496-68 0 0 21.504-6.912 70.4 26.336 20.416-5.696 42.304-8.544 64.096-8.64 21.728.128 43.648 2.944 64.096 8.672 48.864-33.248 70.336-26.336 70.336-26.336 13.952 35.392 5.184 61.504 2.56 68 16.416 17.984 26.304 40.928 26.304 68.992.0 98.72-59.84 120.448-116.864 126.816 9.184 7.936 17.376 23.616 17.376 47.584.0 34.368-.32 62.08-.32 70.496.0 6.88 4.608 14.88 17.6 12.352C438.72 472.145 512 375.857 512 262.353 512 120.401 397.376 5.329 255.968 5.329z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 212 212" id="gitlab"><path d="M12.3 74.7h54L43.3 3c-1-3.6-6.4-3.6-7.6.0L12.3 74.8z"/><path d="M12.3 74.7.5 111c-1 3.2.0 6.8 3 8.8l101.6 74-92.5-119z"/><path d="M105 193.7l-38.6-119h-54l92.7 119z"/><path d="M105 193.7l38.7-119H66.4l38.7 119z"/><path d="M105 193.7l38.7-119H198l-93 119z"/><path d="M198 74.7l11.6 36.2c1 3 0 6.6-3 8.6l-101.5 74 93-119z"/><path d="M198 74.7h-54.3L167 3c1.2-3.6 6.4-3.6 7.6.0L198 74.8z"/></symbol><symbol viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="rss"><circle cx="3.429" cy="20.571" r="3.429"/><path d="M11.429 24h4.57C15.999 15.179 8.821 8.001.0 8v4.572c6.302.001 11.429 5.126 11.429 11.428z"/><path d="M24 24C24 10.766 13.234.0.0.0v4.571c10.714.0 19.43 8.714 19.43 19.429z"/></symbol><symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="linkedin"><path d="M437 0H75C33.648.0.0 33.648.0 75v362c0 41.352 33.648 75 75 75h362c41.352.0 75-33.648 75-75V75c0-41.352-33.648-75-75-75zM181 406h-60V196h60zm0-240h-60v-60h60zm210 240h-60V286c0-16.54-13.46-30-30-30s-30 13.46-30 30v120h-60V196h60v11.309C286.719 202.422 296.93 196 316 196c40.691.043 75 36.547 75 79.688zm0 0"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 612 612" id="to-top"><path d="M604.501 440.509 325.398 134.956c-5.331-5.357-12.423-7.627-19.386-7.27-6.989-.357-14.056 1.913-19.387 7.27L7.499 440.509c-9.999 10.024-9.999 26.298.0 36.323s26.223 10.024 36.222.0l262.293-287.164L568.28 476.832c9.999 10.024 26.222 10.024 36.221.0 9.999-10.023 9.999-26.298.0-36.323z"/></symbol><symbol viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" id="carly"><path d="M504.971 239.029 448 182.059V84c0-46.317-37.682-84-84-84h-44c-13.255.0-24 10.745-24 24s10.745 24 24 24h44c19.851.0 36 16.149 36 36v108c0 6.365 2.529 12.47 7.029 16.971L454.059 256l-47.029 47.029A24.002 24.002.0 004e2 320v108c0 19.851-16.149 36-36 36h-44c-13.255.0-24 10.745-24 24s10.745 24 24 24h44c46.318.0 84-37.683 84-84v-98.059l56.971-56.971c9.372-9.372 9.372-24.568.0-33.941zM112 192V84c0-19.851 16.149-36 36-36h44c13.255.0 24-10.745 24-24S205.255.0 192 0h-44c-46.318.0-84 37.683-84 84v98.059l-56.971 56.97c-9.373 9.373-9.373 24.568.0 33.941L64 329.941V428c0 46.317 37.682 84 84 84h44c13.255.0 24-10.745 24-24s-10.745-24-24-24h-44c-19.851.0-36-16.149-36-36V320c0-6.365-2.529-12.47-7.029-16.971L57.941 256l47.029-47.029A24.002 24.002.0 00112 192z"/></symbol><symbol viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" id="copy"><path d="M23 2.75A2.75 2.75.0 0020.25.0H8.75A2.75 2.75.0 006 2.75v13.5A2.75 2.75.0 008.75 19h11.5A2.75 2.75.0 0023 16.25zM18.25 14.5h-7.5a.75.75.0 010-1.5h7.5a.75.75.0 010 1.5zm0-3h-7.5a.75.75.0 010-1.5h7.5a.75.75.0 010 1.5zm0-3h-7.5a.75.75.0 010-1.5h7.5a.75.75.0 010 1.5z"/><path d="M8.75 20.5A4.255 4.255.0 014.5 16.25V2.75c0-.086.02-.166.025-.25H3.75A2.752 2.752.0 001 5.25v16A2.752 2.752.0 003.75 24h12a2.752 2.752.0 002.75-2.75v-.75z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512.001 512.001" id="closeme"><path d="M284.286 256.002 506.143 34.144c7.811-7.811 7.811-20.475.0-28.285-7.811-7.81-20.475-7.811-28.285.0L256 227.717 34.143 5.859c-7.811-7.811-20.475-7.811-28.285.0-7.81 7.811-7.811 20.475.0 28.285l221.857 221.857L5.858 477.859c-7.811 7.811-7.811 20.475.0 28.285a19.938 19.938.0 0014.143 5.857 19.94 19.94.0 0014.143-5.857L256 284.287l221.857 221.857c3.905 3.905 9.024 5.857 14.143 5.857s10.237-1.952 14.143-5.857c7.811-7.811 7.811-20.475.0-28.285L284.286 256.002z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" id="open-menu"><path d="M492 236H20c-11.046.0-20 8.954-20 20s8.954 20 20 20h472c11.046.0 20-8.954 20-20s-8.954-20-20-20zm0-160H20C8.954 76 0 84.954.0 96s8.954 20 20 20h472c11.046.0 20-8.954 20-20s-8.954-20-20-20zm0 320H20c-11.046.0-20 8.954-20 20s8.954 20 20 20h472c11.046.0 20-8.954 20-20s-8.954-20-20-20z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="instagram"><path d="M12 2.163c3.204.0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849.0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204.0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849.0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zM12 0C8.741.0 8.333.014 7.053.072c-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948s.014 3.668.072 4.948c.2 4.358 2.618 6.78 6.98 6.98C8.333 23.986 8.741 24 12 24s3.668-.014 4.948-.072c4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948s-.014-3.667-.072-4.947c-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403.0-6.162 2.759-6.162 6.162S8.597 18.163 12 18.163s6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zM12 16c-2.209.0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796.0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795.0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="youtube"><path d="M19.615 3.184c-3.604-.246-11.631-.245-15.23.0-3.897.266-4.356 2.62-4.385 8.816.029 6.185.484 8.549 4.385 8.816 3.6.245 11.626.246 15.23.0C23.512 20.55 23.971 18.196 24 12c-.029-6.185-.484-8.549-4.385-8.816zM9 16V8l8 3.993L9 16z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="stackoverflow"><path d="M21 27v-8h3v11H0V19h3v8h18z"/><path d="M17.1.2 15 1.8l7.9 10.6 2.1-1.6L17.1.2zm3.7 14.7L10.6 6.4l1.7-2 10.2 8.5-1.7 2zM7.2 12.3l12 5.6 1.1-2.4-12-5.6-1.1 2.4zm-1.8 6.8 13.56 1.96.17-2.38-13.26-2.55-.47 2.97zM19 25H5v-3h14v3z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" id="xing"><path d="M18.188.0c-.517.0-.741.325-.927.66.0.0-7.455 13.224-7.702 13.657.015.024 4.919 9.023 4.919 9.023.17.308.436.66.967.66h3.454c.211.0.375-.078.463-.22.089-.151.089-.346-.009-.536l-4.879-8.916c-.004-.006-.004-.016.0-.022L22.139.756c.095-.191.097-.387.006-.535C22.056.078 21.894.0 21.686.0h-3.498zM3.648 4.74c-.211.0-.385.074-.473.216-.09.149-.078.339.02.531l2.34 4.05c.004.01.004.016.0.021L1.86 16.051c-.099.188-.093.381.0.529.085.142.239.234.45.234h3.461c.518.0.766-.348.945-.667l3.734-6.609-2.378-4.155c-.172-.315-.434-.659-.962-.659H3.648v.016z"/></symbol><symbol xmlns="http://www.w3.org/2000/svg" viewBox="0 0 71 55" id="discord"><path d="M60.1045 4.8978C55.5792 2.8214 50.7265 1.2916 45.6527.41542 45.5603.39851 45.468.440769 45.4204.525289 44.7963 1.6353 44.105 3.0834 43.6209 4.2216c-5.4572-.817-10.8864-.817-16.2317.0C26.905 3.0581 26.1886 1.6353 25.5617.525289 25.5141.443589 25.4218.40133 25.3294.41542c-5.071.87338-9.9237 2.40318-14.4518 4.48238C10.8384 4.9147 10.8048 4.9429 10.7825 4.9795 1.57795 18.7309-.943561 32.1443.293408 45.3914.299005 45.4562.335386 45.5182.385761 45.5576 6.45866 50.0174 12.3413 52.7249 18.1147 54.5195 18.2071 54.5477 18.305 54.5139 18.3638 54.4378 19.7295 52.5728 20.9469 50.6063 21.9907 48.5383 22.0523 48.4172 21.9935 48.2735 21.8676 48.2256 19.9366 47.4931 18.0979 46.6 16.3292 45.5858 16.1893 45.5041 16.1781 45.304 16.3068 45.2082 16.679 44.9293 17.0513 44.6391 17.4067 44.3461 17.471 44.2926 17.5606 44.2813 17.6362 44.3151c11.6196 5.3051 24.1992 5.3051 35.6817.0C53.3935 44.2785 53.4831 44.2898 53.5502 44.3433 53.9057 44.6363 54.2779 44.9293 54.6529 45.2082 54.7816 45.304 54.7732 45.5041 54.6333 45.5858c-1.7687 1.0339-3.6074 1.9073-5.5412 2.637C48.9662 48.2707 48.9102 48.4172 48.9718 48.5383c1.0662 2.0651 2.2836 4.0316 3.6241 5.8967C52.6519 54.5139 52.7526 54.5477 52.845 54.5195c5.8014-1.7946 11.684-4.5021 17.7569-8.9619C70.6551 45.5182 70.6887 45.459 70.6943 45.3942 72.1747 30.0791 68.2147 16.7757 60.1968 4.9823 60.1772 4.9429 60.1437 4.9147 60.1045 4.8978zM23.7259 37.3253c-3.4983.0-6.3808-3.2117-6.3808-7.156s2.8266-7.156 6.3808-7.156c3.5821.0 6.4367 3.2399 6.3807 7.156.0 3.9443-2.8266 7.156-6.3807 7.156zm23.5919.0c-3.4982.0-6.3807-3.2117-6.3807-7.156s2.8265-7.156 6.3807-7.156c3.5822.0 6.4367 3.2399 6.3808 7.156.0 3.9443-2.7986 7.156-6.3808 7.156z"/></symbol></svg><footer class=footer><div class="footer_inner wrap pale"><img src=https://blog.ogenki.io/icons/apple-touch-icon.png class="icon icon_2 transparent" alt=Ogenki><p>Copyright&nbsp;<span class=year></span>&nbsp;OGENKI. All Rights Reserved</p><a class=to_top href=#documentTop><svg class="icon"><title>to-top</title><use xlink:href="#to-top"/></svg></a></div></footer><script type=text/javascript src=https://blog.ogenki.io/en/js/bundle.4e04b93422786398f3502d560bd5acb3d3f99b2e942c8c11e0fd926ab6ec3ccbd020d4294d58c0825ecb606ef221b34edc81586f1832489816a57ae8f0276615.js integrity="sha512-TgS5NCJ4Y5jzUC1WC9Wss9P5my6ULIwR4P2SarbsPMvQINQpTVjAgl7LYG7yIbNO3IFYbxgySJgWpXro8CdmFQ==" crossorigin=anonymous></script>
<script src=https://blog.ogenki.io/js/search.min.7b8f921696a789f7fe79faac099349dab6a46864e22fe9534b192b4261b32f23f1a54abf7f9310a02cd38c04fb90a2880253a615ebc5be4d29bcaa2b833209e7.js></script></body></html>